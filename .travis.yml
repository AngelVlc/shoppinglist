jobs:
  include:
  - stage: npm audit --audit-level=moderate && test
    language: node_js
    node_js:
    - 10.13.0
    addons:
      chrome: stable
    script:
    - npm audit --audit-level=moderate
    - npm install -g @ionic/cli
    - npm install -g cordova
    - npm test
    - npm run e2e
  - stage: build
    if: tag IS blank OR tag =~ ^(?!v).+
    language: minimal
    script:
    - docker build -t shoppinglist .
    - docker run shoppinglist
  - stage: build && upload to google play
    if: tag =~ ^v
    language: minimal
    before_install:
    - openssl aes-256-cbc -K $encrypted_61627df7c213_key -iv $encrypted_61627df7c213_iv -in google_files.tar.enc -out google_files.tar -d
    - tar xvf google_files.tar
    script:
    - docker build -t shoppinglist --build-arg KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD -f Dockerfile.deploy .
    - docker run shoppinglist